<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HmmOS: qemu notes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HmmOS
   </div>
   <div id="projectbrief">System for Operating</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">qemu notes </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>I had a few notes about QEMU scattered throughout, now that we've gotten a little more intimate I think this deserves its own page</p>
<h1><a class="anchor" id="autotoc_md49"></a>
x86 quirks</h1>
<p>Both of the following make my life easier when running in QEMU, but make it harder for me to handle the expected case for real hardware.</p>
<ul>
<li><em>A20 is set on boot</em>: To be fair, the OSDev wiki states that this is very non-standardized and there are a myriad of ways to enable/disable the A20 line depending on the hardware. In QEMU's case, <a href="https://forum.osdev.org/viewtopic.php?f=1&amp;t=26256">it was already set on boot</a>.</li>
<li><em>No data segment offset limit checks</em>: In real mode, I noticed I can write to 0x0000:0xB8000 without having to use unreal mode. Similarly, when in protected mode/unreal mode, I was unable to trigger the segment check (which should cause a <a href="https://wiki.osdev.org/Exceptions#General_Protection_Fault">GPF</a>) even if I manually set the limits low. It seems that QEMU doesn't perform the limit checks (<a href="https://lists.gnu.org/archive/html/qemu-devel/2019-02/msg06518.html">at least as of 2019</a>). I do get GPFs for the code segment though.</li>
<li><em>PCI vendor ID 0x1234</em>: According to <a href="https://web.archive.org/web/20200416081308/https://www.kraxel.org/blog/2020/01/qemu-pci-ids/">this blog post</a>. Indeed 0x1234 doesn't show up on the <a href="https://devicehunt.com/all-pci-vendors">list of PCI vendors</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md50"></a>
QEMU/KVM bugs/weirdness</h1>
<ul>
<li>See "hmm.md#slow\_memory\_speed" for a QEMU emulation performance issue.</li>
<li>See "hmm.md#KVM memory invalidation heisenbug" for what seems to be a KVM bug.</li>
<li>See "demos.md#locking" which demonstrates that increment (a++) appears to be atomic in QEMU emulation</li>
</ul>
<p>Probably if I tried hard enough both of these can be linked to QEMU/KVM code but I haven't found the time to look deeper.</p>
<h1><a class="anchor" id="autotoc_md51"></a>
default QEMU setup</h1>
<p>The default OS setup uses a Q35 architecture (based on <a href="https://wiki.qemu.org/Features/Q35">Intel's ~2009 ICH9 architecture</a>), which treats drivers as AHCI/SATA by default rather than IDE.</p>
<p>We use QEMU emulation by default unless you pass <code>-accel kvm</code> (<code>make run KVM=1</code>). It's good to test with both emulation modes to shake out differences in emulation (just as running with both GCC and clang is a good idea).</p>
<h1><a class="anchor" id="autotoc_md52"></a>
useful debugging flags</h1>
<p>These all feature in some form in the Makefile:</p>
<ul>
<li><code>-serial stdio</code> (default): useful for emulating a serial port and receiving output on the host machine</li>
<li><code>-display none -serial stdio</code> (<code>make run TEST=...</code>): useful for running tests since the OS doesn't take any input</li>
<li><code>-d int,cpu_reset -no-reboot</code> (<code>make run SHOWINT=1</code>): logging of interrupts and cpu reset (i.e. during a triple fault). <code>-no-reboot</code> prevents automatic rebooting during triple-fault</li>
<li><code>-S -s</code> (<code>make runi</code>): start gdbserver at localhost:1234 and wait for GDB</li>
<li><code>-monitor unix:qemu-monitor-socket,server,nowait</code> (<code>make run QMONITOR=1</code>): allows you to <a href="https://wiki.qemu.org/Features/Q35">connect to the QEMU monitor</a> via socket. Some useful monitor commands:<ul>
<li><code>info tlb</code>: when debugging memory mapping issues</li>
<li><code>info qtree</code>: to <a href="https://serverfault.com/a/913622">dump emulated device info</a></li>
</ul>
</li>
<li><code>-trace enable=ahci_*</code> or similar. See <code>qemu-system-i386 -trace ?</code> to view all trace tags.</li>
</ul>
<p>The GDB and qmonitor <code>make</code> commands come in pairs: one to start the VM/gdbserver/monitor server, and the other to start gdb/QEMU monitor:</p><ul>
<li><code>make runi</code>/<code>make gdb</code></li>
<li><code>make run QMONITOR=1</code>/<code>make qmonitor</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>

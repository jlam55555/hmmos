<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HmmOS: src/kernel/fs/vfs.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HmmOS
   </div>
   <div id="projectbrief">System for Operating</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_cbd7f246bdf7dc0a50281a272327e6ed.html">kernel</a></li><li class="navelem"><a class="el" href="dir_f848a285e60993dcb3189737897d2857.html">fs</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">vfs.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Virtual filesystem.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="result_8h_source.html">fs/result.h</a>&quot;</code><br />
<code>#include &quot;nonstd/allocator.h&quot;</code><br />
<code>#include &quot;nonstd/node_hash_map.h&quot;</code><br />
<code>#include &quot;nonstd/string.h&quot;</code><br />
<code>#include &quot;<a class="el" href="string__view_8h_source.html">nonstd/string_view.h</a>&quot;</code><br />
<code>#include &quot;nonstd/vector.h&quot;</code><br />
<code>#include &quot;<a class="el" href="intrusive__list_8h_source.html">util/intrusive_list.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="objutil_8h_source.html">util/objutil.h</a>&quot;</code><br />
<code>#include &lt;optional&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for vfs.h:</div>
<div class="dyncontent">
<div class="center"><img src="vfs_8h__incl.png" border="0" usemap="#asrc_2kernel_2fs_2vfs_8h" alt=""/></div>
<map name="asrc_2kernel_2fs_2vfs_8h" id="asrc_2kernel_2fs_2vfs_8h">
<area shape="rect" title="Virtual filesystem." alt="" coords="1129,5,1266,31"/>
<area shape="rect" href="result_8h.html" title="Result enum, a two&#45;byte enum akin to errno." alt="" coords="451,79,538,104"/>
<area shape="rect" href="allocator_8h_source.html" title=" " alt="" coords="1785,225,1924,251"/>
<area shape="rect" href="node__hash__map_8h_source.html" title=" " alt="" coords="1407,79,1595,104"/>
<area shape="rect" href="string_8h_source.html" title=" " alt="" coords="827,79,946,104"/>
<area shape="rect" href="string__view_8h.html" title="Simple implementation of C++20/23&#45;ish string_view. Features are implemented as needed." alt="" coords="649,152,805,177"/>
<area shape="rect" href="vector_8h_source.html" title=" " alt="" coords="1344,152,1467,177"/>
<area shape="rect" href="intrusive__list_8h.html" title="Circular intrusive list implementation, inspired by Linux&#39;s LIST_HEAD." alt="" coords="1126,152,1269,177"/>
<area shape="rect" href="objutil_8h.html" title="Utility functions/macros for C++ objects." alt="" coords="1002,152,1102,177"/>
<area shape="rect" title=" " alt="" coords="1952,79,2027,104"/>
<area shape="rect" title=" " alt="" coords="629,299,696,324"/>
<area shape="rect" title=" " alt="" coords="1569,299,1639,324"/>
<area shape="rect" title=" " alt="" coords="991,299,1062,324"/>
<area shape="rect" title=" " alt="" coords="1825,299,1884,324"/>
<area shape="rect" href="libc__minimal_8h.html" title="A small subset of the C standard library that can also be used in the bootloader." alt="" coords="31,299,150,324"/>
<area shape="rect" href="hash__bytes_8h_source.html" title=" " alt="" coords="381,225,537,251"/>
<area shape="rect" href="list_8h_source.html" title=" " alt="" coords="1491,152,1594,177"/>
<area shape="rect" href="assert_8h.html" title="Runtime assertion macros. Note that static_assert will remain as it is." alt="" coords="1228,225,1327,251"/>
<area shape="rect" title=" " alt="" coords="1650,225,1761,251"/>
<area shape="rect" title=" " alt="" coords="764,225,849,251"/>
<area shape="rect" title=" " alt="" coords="1771,152,1826,177"/>
<area shape="rect" title=" " alt="" coords="1289,299,1381,324"/>
<area shape="rect" title=" " alt="" coords="5,372,80,397"/>
<area shape="rect" title=" " alt="" coords="105,372,175,397"/>
<area shape="rect" title=" " alt="" coords="460,299,540,324"/>
<area shape="rect" title=" " alt="" coords="1165,299,1225,324"/>
<area shape="rect" title=" " alt="" coords="1453,225,1523,251"/>
<area shape="rect" href="perf_8h.html" title="Utilities for performance optimization." alt="" coords="845,299,904,324"/>
<area shape="rect" href="libc_8h.html" title="Implementation of a small part of the C standard library, for kernel use." alt="" coords="199,225,305,251"/>
<area shape="rect" title=" " alt="" coords="561,225,639,251"/>
<area shape="rect" title=" " alt="" coords="365,299,435,324"/>
<area shape="rect" title=" " alt="" coords="173,299,251,324"/>
<area shape="rect" title=" " alt="" coords="275,299,341,324"/>
<area shape="rect" href="bw_8h.html" title="Bitwise operations, especially on structs." alt="" coords="1025,225,1103,251"/>
</map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="vfs_8h__dep__incl.png" border="0" usemap="#asrc_2kernel_2fs_2vfs_8hdep" alt=""/></div>
<map name="asrc_2kernel_2fs_2vfs_8hdep" id="asrc_2kernel_2fs_2vfs_8hdep">
<area shape="rect" title="Virtual filesystem." alt="" coords="187,5,324,31"/>
<area shape="rect" href="fat32_8h.html" title="FAT32 filesystem driver." alt="" coords="5,79,156,119"/>
<area shape="rect" href="elf_8h.html" title="ELF file parser." alt="" coords="181,86,330,111"/>
<area shape="rect" href="process_8h.html" title="Process abstraction (a.k.a. userspace thread)." alt="" coords="355,86,537,111"/>
</map>
</div>
</div>
<p><a href="vfs_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfs_1_1Inode.html">fs::Inode</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfs_1_1Dentry.html">fs::Dentry</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfs_1_1File.html">fs::File</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfs_1_1Filesystem.html">fs::Filesystem</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="typedef-members" name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:aaa0c1b6f92de6e4fdf0df34eb5fcbd2a"><td class="memItemLeft" align="right" valign="top"><a id="aaa0c1b6f92de6e4fdf0df34eb5fcbd2a" name="aaa0c1b6f92de6e4fdf0df34eb5fcbd2a"></a>
using&#160;</td><td class="memItemRight" valign="bottom"><b>fs::DentrySiblingList</b> = <a class="el" href="classutil_1_1IntrusiveListHead.html">util::IntrusiveListHead</a>&lt; Dentry &gt;</td></tr>
<tr class="separator:aaa0c1b6f92de6e4fdf0df34eb5fcbd2a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac5c3ccd8df992e423d506c8ee8caff4a"><td class="memItemLeft" align="right" valign="top"><a id="ac5c3ccd8df992e423d506c8ee8caff4a" name="ac5c3ccd8df992e423d506c8ee8caff4a"></a>
using&#160;</td><td class="memItemRight" valign="bottom"><b>fs::FileDescriptor</b> = unsigned</td></tr>
<tr class="separator:ac5c3ccd8df992e423d506c8ee8caff4a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4ec86255e158b29eff4ef7f83a761157"><td class="memItemLeft" align="right" valign="top"><a id="a4ec86255e158b29eff4ef7f83a761157" name="a4ec86255e158b29eff4ef7f83a761157"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>fs::init</b> (Filesystem &amp;root_fs)</td></tr>
<tr class="separator:a4ec86255e158b29eff4ef7f83a761157"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a01df28048f4970e6faedc3c5cdba844d"><td class="memItemLeft" align="right" valign="top">Dentry *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfs_8cc.html#a01df28048f4970e6faedc3c5cdba844d">fs::pathname_lookup</a> (<a class="el" href="classnonstd_1_1string__view.html">nonstd::string_view</a> path, Result &amp;res)</td></tr>
<tr class="separator:a01df28048f4970e6faedc3c5cdba844d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a8b042e7bbd995d00f3abb9c76eaa463f"><td class="memItemLeft" align="right" valign="top"><a id="a8b042e7bbd995d00f3abb9c76eaa463f" name="a8b042e7bbd995d00f3abb9c76eaa463f"></a>
constexpr FileDescriptor&#160;</td><td class="memItemRight" valign="bottom"><b>fs::InvalidFD</b> = -1</td></tr>
<tr class="separator:a8b042e7bbd995d00f3abb9c76eaa463f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Virtual filesystem. </p>
<p>This is the implementation of the "everything is a file" interface. This comprises the following components:</p>
<ul>
<li>Inode ("index node"): An in-memory representation of a filesystem object. Each filesystem type (e.g., FAT, ext4, in-memory filesystems like tmpfs) have to implement their own Inode type with its own set of file operations. These are reference counted and automatically destroyed.</li>
<li>Dentry: ("directory entry"): A handle to an inode, along with path information. These are the VFS's filesystem-independent in-memory representation of filesystem objects, and play an important part in pathname resolution. Collectively, dentries form the "dcache" (dentry cache), which allow us to avoid expensive filesystem reads on every filesystem lookup. Path lookups first perform a hashtable lookup of the dcache before falling back to the filesystem's <em>lookup()</em> method.</li>
<li>File: The representation of a file opened by a process. This wraps a dentry with seek position. Any number of Files can refer to the same Dentry (and will prevent the file from being deleted while it is open).</li>
<li>Filesystem: In this context, the filesystem is the class that maintains superblock information and imbues inodes with its set of file operations. Of course, we'll need a different filesystem implementation for each filesystem protocol (e.g., FAT, ext4, etc.). The VFS must register a root filesystem and can mount additional filesystems.</li>
<li>Superblock: Colloquially, this refers to a single instance of a filesystem (corresponding to a single disk partition, a single mount point, and represented via a single filesystem object). The more traditional definition refers to the on-disk metadata associated with one such filesystem instance.</li>
</ul>
<p>TODO: make this thread safe. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a01df28048f4970e6faedc3c5cdba844d" name="a01df28048f4970e6faedc3c5cdba844d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01df28048f4970e6faedc3c5cdba844d">&#9670;&#160;</a></span>pathname_lookup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Dentry * fs::pathname_lookup </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classnonstd_1_1string__view.html">nonstd::string_view</a>&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Result &amp;&#160;</td>
          <td class="paramname"><em>res</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The main pathname lookup logic. Start from the filesystem root, and for each component:</p><ol type="1">
<li>If it is . or .., handle appropriately.</li>
<li>Otherwise, attempt to look up the name in the dcache hashtable.</li>
<li>If not found, delegate to the filesystem's <em>lookup()</em> method, which will return an inode. We'll create a dentry from this inode.</li>
<li>If not found, return nullptr and set res to Result::FileNotFound. Otherwise continue to the next component (if any). </li>
</ol>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>

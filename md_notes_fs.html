<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HmmOS: filesystem and disk drivers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HmmOS
   </div>
   <div id="projectbrief">System for Operating</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">filesystem and disk drivers </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>at first I thought this could wait until after implementing userspace processes, but then I realized that it's quite annoying to load practical userspace programs that are stored in the kernel binary itself and have a purely in-memory layout.</p>
<p>The initial goals for the HmmOS filesystem are, in order:</p><ol type="1">
<li>write the HmmOS kernel and userspace programs to a FAT filesystem</li>
<li>implement basic FAT support in the bootloader (to find the kernel)</li>
<li>write a basic disk driver that can read/write one block at a time</li>
<li>implement FAT support in the kernel to load userspace programs</li>
<li>(later) write an ELF loader and store the binaries in ELF form rather than flat binaries</li>
</ol>
<h2><a class="anchor" id="autotoc_md23"></a>
preparing the filesystem disk</h2>
<p>The process is not very different than before. Rather than storing the flat kernel binary at a particular offset within the raw disk image, we'll store a filesystem image there instead:</p>
<ol type="1">
<li>Create a filesystem image (using <code>mkfs.fat</code>).</li>
<li>Write the kernel and other necessary files to the filesystem image (using <code>mtools</code>).</li>
<li>Write the bootloader at the start of the raw disk image.</li>
<li>Write the filesystem image at the partition offset (instead of the flat kernel binary).</li>
</ol>
<div class="fragment"><div class="line">$ # Generate the empty filesystem image (FAT32 minimum size is 32MB).</div>
<div class="line">$ dd if=/dev/zero of=filesystem.img bs=1M count=33</div>
<div class="line">$</div>
<div class="line">$ # Generate the filesystem.</div>
<div class="line">$ /sbin/mkfs.fat -F32 filesystem.img</div>
<div class="line">$</div>
<div class="line">$ # Write kernel image to `/KERNEL.BIN`.</div>
<div class="line">$ mcopy -i filesystem.img out/kernel_test.bin ::KERNEL.BIN</div>
<div class="line">$ mdir -i filesystem.img ::</div>
<div class="line"> Volume in drive : has no label</div>
<div class="line"> Volume Serial Number is C72B-1CDB</div>
<div class="line">Directory for ::/</div>
<div class="line"> </div>
<div class="line">KERNEL   BIN    123416 2024-12-23  14:46</div>
<div class="line">        1 file              123 416 bytes</div>
<div class="line">                         33 929 728 bytes free</div>
<div class="line">$</div>
<div class="line">$ # Install filesystem image just as we had installed the kernel bin.</div>
<div class="line">$ scripts/install_bootloader.py \</div>
<div class="line">$     -b bootloader.img -k filesystem.img -o disk.img</div>
</div><!-- fragment --><p>The bootloader code lives in the sectors immediately following the MBR, and does not live on the partition containing the kernel and userspace code (i.e. no executable code in the VBR). If the bootloader grows too large, we can possibly store later stages of it in the filesystem similar to the kernel to be dynamically loaded at runtime.</p>
<h2><a class="anchor" id="autotoc_md24"></a>
finding and loading the kernel image from the partition</h2>
<p>Let's assume the kernel image is written in the root directory with name "KERNEL.BIN". We need to be able to locate and read this file into memory. For simplicity, the bootloader will maintain its own minimal FAT32 implementation for the sole purpose of loading the kernel binary.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
disk interfaces</h1>
<p>(may split this out into another notes file if this gets too long)</p>
<ul>
<li><b>SATA (Serial AT Attachment)</b>: common physical interface for hard drives. Can be accessed using the ATA (older) or AHCI (newer) software interfaces.</li>
<li><b>PATA (Parallel AT Attachment)</b>: older than SATA, can be accessed using the ATA interface.</li>
<li><b>IDE (Integrated Drive Electronics)</b>: original name for PATA</li>
<li><b>ATAPI (ATA Packet Interface)</b>: extensions to ATA to support more devices other than hard drives (e.g. optical drives, SCSI devices)</li>
<li><b>AHCI (Advanced Host Controller Interface)</b>: encapsulates SATA devices and provides a standard PCI interface. Supports all of the ATA functionality and more.</li>
<li><b>PCI (Peripheral Component Interconnect)</b>: a high-performance bus for peripherals; can be used to enumerate devices.</li>
<li><b>HBA (Host Bus Adapter)</b>: the AHCI controller. Usually this refers to a physical extension card or onboard chip that connects external storage to a system bus. NICs are similar for networking.</li>
<li><b>FIS (Frame Information Structure)</b>: The packets used to communicate between the CPU and the HBA.</li>
</ul>
<p>For HmmOS, we'll start with a simple AHCI driver. We can start with PIO-mode (slow but simple) and then implement DMA.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
TODO</h2>
<ul>
<li>[X] write the HmmOS kernel to a FAT32 filesystem</li>
<li>[X] implement basic FAT32 support in the bootloader</li>
<li>[ ] write a basic AHCI driver in the kernel</li>
<li>[ ] implement FAT32 support in the kernel to load userspace programs</li>
</ul>
<p>Further TODO items</p><ul>
<li>[ ] write an ELF loader and store the binaries in ELF format</li>
<li>[ ] VFS layer</li>
<li>[ ] ext2 support</li>
<li>[ ] NVMe support </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>

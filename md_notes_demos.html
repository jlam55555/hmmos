<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HmmOS: demos.md</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HmmOS
   </div>
   <div id="projectbrief">System for Operating</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">demos.md </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Educational demonstrations of important OS behavior</p>
<h2><a class="anchor" id="autotoc_md19"></a>
locking</h2>
<p>The very basic example: two threads incrementing a shared variable. There are some notable omissions here but this is to get the basic idea.</p>
<div class="fragment"><div class="line">constexpr uint64_t n = 1&#39;000&#39;000&#39;000;</div>
<div class="line">uint64_t j = 0;</div>
<div class="line">uint64_t done1 = 0;</div>
<div class="line"> </div>
<div class="line">void foo() {</div>
<div class="line">  for (uint64_t i = 0; i &lt; n; ++i) {</div>
<div class="line">    ++j;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  done1 = arch::time::rdtsc();</div>
<div class="line">  scheduler-&gt;destroy_thread();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void main() {</div>
<div class="line">  sched::Scheduler scheduler;</div>
<div class="line">  scheduler.bootstrap();</div>
<div class="line">  scheduler.new_thread(&amp;foo);</div>
<div class="line"> </div>
<div class="line">  uint64_t start = arch::time::rdtsc();</div>
<div class="line">  for (uint64_t i = 0; i &lt; n; ++i) {</div>
<div class="line">    ++j;</div>
<div class="line">  }</div>
<div class="line">  uint64_t done2 = arch::time::rdtsc();</div>
<div class="line"> </div>
<div class="line">  while (!done1) {</div>
<div class="line">    hlt;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  nonstd::printf(&quot;j=%llu\r\n&quot;, j);</div>
<div class="line">  nonstd::printf(&quot;elapsed=%llu\r\n&quot;, std::max(done1, done2) - start);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Interestingly, QEMU emulation by default generates an atomic increment operation, but with KVM we see the intended effect. We can introduce locking in a uniprocessor system using <code>cli</code>/<code>sti</code> around the "critical sections" (the increment ops).</p>
<div class="fragment"><div class="line">j=2000000000  # QEMU default</div>
<div class="line">j=1816044630  # KVM</div>
<div class="line">j=2000000000  # KVM w/ locking</div>
</div><!-- fragment --><p>It's also worth measuring the overhead of the locking.</p>
<div class="fragment"><div class="line">elapsed=34767593327   # QEMU, no locking</div>
<div class="line">elapsed=104330302146  # QEMU, locking (200% increase)</div>
<div class="line">elapsed=5601347345    # KVM, no locking</div>
<div class="line">elapsed=16394652151   # KVM, locking (193% increase)</div>
</div><!-- fragment --><p>Both for QEMU and KVM emulation, it takes almost exactly three times as long to run with locking enabled vs. no locking.</p>
<p>(Also interesting, the KVM virtualization runs 6.2 times as fast as the QEMU emulation).</p>
<p>For context, here's the disassembly of the entirety of <code>foo()</code> (compiled with clang with default optimization):</p>
<div class="fragment"><div class="line">fe005e40 &lt;(anonymous namespace)::foo()&gt;:</div>
<div class="line">fe005e40:       55                      push   %ebp</div>
<div class="line">fe005e41:       89 e5                   mov    %esp,%ebp</div>
<div class="line">fe005e43:       56                      push   %esi</div>
<div class="line">fe005e44:       83 ec 14                sub    $0x14,%esp</div>
<div class="line">fe005e47:       c7 45 f4 00 00 00 00    movl   $0x0,-0xc(%ebp)</div>
<div class="line">fe005e4e:       c7 45 f0 00 00 00 00    movl   $0x0,-0x10(%ebp)</div>
<div class="line"> </div>
<div class="line"># Loop start</div>
<div class="line">fe005e55:       8b 75 f0                mov    -0x10(%ebp),%esi</div>
<div class="line">fe005e58:       8b 4d f4                mov    -0xc(%ebp),%ecx</div>
<div class="line">fe005e5b:       31 c0                   xor    %eax,%eax</div>
<div class="line">fe005e5d:       ba ff c9 9a 3b          mov    $0x3b9ac9ff,%edx</div>
<div class="line">fe005e62:       29 f2                   sub    %esi,%edx</div>
<div class="line">fe005e64:       19 c8                   sbb    %ecx,%eax</div>
<div class="line">fe005e66:       0f 82 2d 00 00 00       jb     fe005e99 &lt;(anonymous namespace)::foo()+0x59&gt;</div>
<div class="line">fe005e6c:       e9 00 00 00 00          jmp    fe005e71 &lt;(anonymous namespace)::foo()+0x31&gt;</div>
<div class="line">fe005e71:       fa                      cli</div>
<div class="line">fe005e72:       a1 30 ca 00 fe          mov    0xfe00ca30,%eax</div>
<div class="line">fe005e77:       83 c0 01                add    $0x1,%eax</div>
<div class="line">fe005e7a:       83 15 34 ca 00 fe 00    adcl   $0x0,0xfe00ca34</div>
<div class="line">fe005e81:       a3 30 ca 00 fe          mov    %eax,0xfe00ca30</div>
<div class="line">fe005e86:       fb                      sti</div>
<div class="line">fe005e87:       8b 45 f4                mov    -0xc(%ebp),%eax</div>
<div class="line">fe005e8a:       83 45 f0 01             addl   $0x1,-0x10(%ebp)</div>
<div class="line">fe005e8e:       83 d0 00                adc    $0x0,%eax</div>
<div class="line">fe005e91:       89 45 f4                mov    %eax,-0xc(%ebp)</div>
<div class="line">fe005e94:       e9 bc ff ff ff          jmp    fe005e55 &lt;(anonymous namespace)::foo()+0x15&gt;</div>
<div class="line"># Loop end</div>
<div class="line"> </div>
<div class="line">fe005e99:       e8 42 b1 ff ff          call   fe000fe0 &lt;arch::time::rdtsc()&gt;</div>
<div class="line">fe005e9e:       89 15 3c ca 00 fe       mov    %edx,0xfe00ca3c</div>
<div class="line">fe005ea4:       a3 38 ca 00 fe          mov    %eax,0xfe00ca38</div>
<div class="line">fe005ea9:       a1 28 ca 00 fe          mov    0xfe00ca28,%eax</div>
<div class="line">fe005eae:       31 c9                   xor    %ecx,%ecx</div>
<div class="line">fe005eb0:       89 04 24                mov    %eax,(%esp)</div>
<div class="line">fe005eb3:       c7 44 24 04 00 00 00    movl   $0x0,0x4(%esp)</div>
<div class="line">fe005eba:       00</div>
<div class="line">fe005ebb:       e8 90 01 00 00          call   fe006050 &lt;sched::Scheduler::destroy_thread(sched::KernelThread*)&gt;</div>
<div class="line">fe005ec0:       83 c4 14                add    $0x14,%esp</div>
<div class="line">fe005ec3:       5e                      pop    %esi</div>
<div class="line">fe005ec4:       5d                      pop    %ebp</div>
<div class="line">fe005ec5:       c3                      ret</div>
</div><!-- fragment --><p>So while one might be naively tempted to say that <code>cli</code>/<code>sti</code> add two "instructions" (line of code) to the loop body hence increasing the runtime by 300%, this is clearly not true by looking at the disassembled loop body. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
